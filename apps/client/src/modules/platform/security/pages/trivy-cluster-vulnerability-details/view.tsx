import { PageWrapper } from "@/core/components/PageWrapper";
import { routeTrivyClusterVulnerabilityDetails } from "./route";
import { PATH_TRIVY_CLUSTER_VULNERABILITIES_FULL } from "../trivy-cluster-vulnerabilities/route";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/core/components/ui/tabs";
import { Badge } from "@/core/components/ui/badge";
import { ClusterReportHeader } from "./components/ClusterReportHeader";
import { ClusterVulnerabilitiesList } from "./components/ClusterVulnerabilitiesList";
import { useClusterVulnerabilityReportWatchItem } from "@/k8s/api/groups/Trivy/ClusterVulnerabilityReport";
import { Info, ShieldAlert } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/core/components/ui/card";
import { clusterVulnerabilityReportLabels } from "@my-project/shared";

export default function TrivyClusterVulnerabilityDetailsPageContent() {
  const { name, clusterName } = routeTrivyClusterVulnerabilityDetails.useParams();

  const {
    data: report,
    isLoading,
    query,
  } = useClusterVulnerabilityReportWatchItem({
    name,
  });

  if (query.error) {
    return (
      <PageWrapper
        breadcrumbs={[
          { label: "Security" },
          { label: "Cluster Security" },
          {
            label: "Cluster Vulnerability Reports",
            route: {
              to: PATH_TRIVY_CLUSTER_VULNERABILITIES_FULL,
              params: { clusterName },
            },
          },
          { label: name },
        ]}
      >
        <div className="flex items-center justify-center p-8">
          <div className="text-center">
            <h2 className="text-lg font-semibold text-red-600">Error Loading Report</h2>
            <p className="text-muted-foreground mt-2">{query.error.message}</p>
          </div>
        </div>
      </PageWrapper>
    );
  }

  const vulnerabilityCount = report?.report.vulnerabilities?.length || 0;

  return (
    <PageWrapper
      breadcrumbs={[
        { label: "Security" },
        { label: "Cluster Security" },
        {
          label: "Cluster Vulnerability Reports",
          route: {
            to: PATH_TRIVY_CLUSTER_VULNERABILITIES_FULL,
            params: { clusterName },
          },
        },
        { label: "Report Details" },
      ]}
    >
      <div className="space-y-4">
        <ClusterReportHeader report={report} isLoading={isLoading} />

        <Tabs defaultValue="vulnerabilities" className="w-full">
          <TabsList className="w-full justify-start">
            <TabsTrigger value="overview">
              <Info className="mr-2 h-4 w-4" />
              Overview
            </TabsTrigger>
            <TabsTrigger value="vulnerabilities">
              <ShieldAlert className="mr-2 h-4 w-4" />
              Vulnerabilities
              {vulnerabilityCount > 0 && (
                <Badge variant="secondary" className="ml-2">
                  {vulnerabilityCount}
                </Badge>
              )}
            </TabsTrigger>
          </TabsList>

          <TabsContent value="overview" className="mt-4">
            <div className="grid gap-4 md:grid-cols-2">
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Scan Information</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Scanner</span>
                    <span>{report?.report.scanner?.name || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Scanner Version</span>
                    <span>{report?.report.scanner?.version || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Vendor</span>
                    <span>{report?.report.scanner?.vendor || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Last Scan</span>
                    <span>
                      {report?.report.updateTimestamp ? new Date(report.report.updateTimestamp).toLocaleString() : "-"}
                    </span>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Image Information</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Registry</span>
                    <span>{report?.report.registry?.server || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Repository</span>
                    <span>{report?.report.artifact.repository || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Tag</span>
                    <span>{report?.report.artifact.tag || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Digest</span>
                    <span className="max-w-[200px] truncate text-xs" title={report?.report.artifact.digest}>
                      {report?.report.artifact.digest || "-"}
                    </span>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Operating System</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Family</span>
                    <span>{report?.report.os?.family || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Version</span>
                    <span>{report?.report.os?.name || "-"}</span>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Resource Information</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Scope</span>
                    <span>Cluster</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Resource Kind</span>
                    <span>{report?.metadata.labels?.[clusterVulnerabilityReportLabels.resourceKind] || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Resource Name</span>
                    <span>{report?.metadata.labels?.[clusterVulnerabilityReportLabels.resourceName] || "-"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Container</span>
                    <span>{report?.metadata.labels?.[clusterVulnerabilityReportLabels.containerName] || "-"}</span>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          <TabsContent value="vulnerabilities" className="mt-4">
            <ClusterVulnerabilitiesList report={report} isLoading={isLoading} />
          </TabsContent>
        </Tabs>
      </div>
    </PageWrapper>
  );
}
