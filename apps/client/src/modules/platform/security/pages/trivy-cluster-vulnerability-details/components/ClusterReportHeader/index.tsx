import { Badge } from "@/core/components/ui/badge";
import { CopyButton } from "@/core/components/CopyButton";
import { Shield } from "lucide-react";
import { ClusterVulnerabilityReport, clusterVulnerabilityReportLabels } from "@my-project/shared";
import { TrivyReportDetailHeader } from "@/modules/platform/security/components/shared/TrivyReportDetailHeader";
import { getVulnSummaryStats } from "@/modules/platform/security/components/shared/TrivyReportDetailHeader/utils";

interface ClusterReportHeaderProps {
  report: ClusterVulnerabilityReport | undefined;
  isLoading: boolean;
}

export function ClusterReportHeader({ report, isLoading }: ClusterReportHeaderProps) {
  const summary = report?.report.summary;
  const registry = report?.report.registry?.server || "";
  const repository = report?.report.artifact.repository || "";
  const tag = report?.report.artifact.tag || "latest";
  const fullImage = registry ? `${registry}/${repository}:${tag}` : `${repository}:${tag}`;
  const containerName = report?.metadata.labels?.[clusterVulnerabilityReportLabels.containerName] || "";
  const resourceKind = report?.metadata.labels?.[clusterVulnerabilityReportLabels.resourceKind] || "";
  const resourceName = report?.metadata.labels?.[clusterVulnerabilityReportLabels.resourceName] || "";

  const totalVulnerabilities = summary
    ? summary.criticalCount + summary.highCount + summary.mediumCount + summary.lowCount + summary.unknownCount
    : 0;

  return (
    <TrivyReportDetailHeader
      isLoading={isLoading}
      isEmpty={!report}
      icon={Shield}
      title={fullImage}
      titleExtra={
        <>
          <CopyButton text={fullImage} />
          {totalVulnerabilities === 0 && summary && <Badge variant="success">No Vulnerabilities</Badge>}
        </>
      }
      metadata={
        <>
          {containerName && (
            <span>
              Container: <span className="text-foreground">{containerName}</span>
            </span>
          )}
          {resourceKind && resourceName && (
            <span>
              Resource:{" "}
              <span className="text-foreground">
                {resourceKind}/{resourceName}
              </span>
            </span>
          )}
          <span>
            Scope: <span className="text-foreground">Cluster</span>
          </span>
        </>
      }
      badges={
        report?.report.os ? (
          <Badge variant="secondary" className="text-xs">
            {report.report.os.family} {report.report.os.name}
          </Badge>
        ) : undefined
      }
      summaryStats={summary ? getVulnSummaryStats(summary) : []}
    />
  );
}
