import { Card, CardContent, CardFooter, CardHeader } from "@/core/components/ui/card";
import { PortfolioMetrics } from "@my-project/shared";
import { getLatestMetrics, calculatePercent, formatLastMeasurement } from "../../utils/metrics";
import { MetricProgressBar } from "../shared/MetricProgressBar";
import { VulnerabilityTrendChart as SharedVulnerabilityTrendChart } from "../shared/VulnerabilityTrendChart";
import { SEVERITY_COLORS } from "../../constants/colors";

export interface VulnerabilityTrendChartWidgetProps {
  metrics: PortfolioMetrics[] | undefined;
  isLoading?: boolean;
}

/**
 * Dashboard widget for vulnerability trends
 * Composes the shared VulnerabilityTrendChart with Card wrapper and footer metrics
 */
export function VulnerabilityTrendChart({ metrics, isLoading }: VulnerabilityTrendChartWidgetProps) {
  const latestMetrics = getLatestMetrics(metrics);

  // Calculate percentages
  const total = latestMetrics?.vulnerabilities ?? 0;
  const critical = latestMetrics?.critical ?? 0;
  const high = latestMetrics?.high ?? 0;
  const medium = latestMetrics?.medium ?? 0;
  const low = latestMetrics?.low ?? 0;
  const unassigned = latestMetrics?.unassigned ?? 0;

  const criticalPercent = calculatePercent(total, critical);
  const highPercent = calculatePercent(total, high);
  const mediumPercent = calculatePercent(total, medium);
  const lowPercent = calculatePercent(total, low);
  const unassignedPercent = calculatePercent(total, unassigned);

  const lastMeasurement = latestMetrics ? formatLastMeasurement(latestMetrics.lastOccurrence) : "N/A";

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <h4 className="text-lg font-semibold">Portfolio Vulnerabilities</h4>
            <p className="text-muted-foreground text-sm">Last measurement: {lastMeasurement}</p>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        <SharedVulnerabilityTrendChart metrics={metrics} isLoading={isLoading} />
      </CardContent>
      <CardFooter>
        <div className="grid w-full grid-cols-1 gap-4 md:grid-cols-5">
          <MetricProgressBar
            label="Critical"
            value={critical}
            percent={criticalPercent}
            color={SEVERITY_COLORS.CRITICAL}
          />
          <MetricProgressBar label="High" value={high} percent={highPercent} color={SEVERITY_COLORS.HIGH} />
          <MetricProgressBar label="Medium" value={medium} percent={mediumPercent} color={SEVERITY_COLORS.MEDIUM} />
          <MetricProgressBar label="Low" value={low} percent={lowPercent} color={SEVERITY_COLORS.LOW} />
          <MetricProgressBar
            label="Unassigned"
            value={unassigned}
            percent={unassignedPercent}
            color={SEVERITY_COLORS.UNASSIGNED}
          />
        </div>
      </CardFooter>
    </Card>
  );
}
