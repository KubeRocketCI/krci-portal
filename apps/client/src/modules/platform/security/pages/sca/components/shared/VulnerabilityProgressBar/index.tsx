import { SEVERITY_COLORS } from "../../../constants/colors";
import { StackedProgressBar, ProgressSegment } from "../StackedProgressBar";

/**
 * Metrics object shape (from DependencyTrackComponentMetrics)
 */
interface MetricsObject {
  critical?: number;
  high?: number;
  medium?: number;
  low?: number;
  unassigned?: number;
  vulnerabilities?: number;
}

export interface VulnerabilityProgressBarProps {
  /** Individual severity value - Critical count */
  critical?: number;
  /** Individual severity value - High count */
  high?: number;
  /** Individual severity value - Medium count */
  medium?: number;
  /** Individual severity value - Low count */
  low?: number;
  /** Individual severity value - Unassigned count */
  unassigned?: number;
  /** Individual severity value - Total vulnerabilities */
  total?: number;
  /** Alternative: pass a metrics object directly */
  metrics?: MetricsObject;
}

/**
 * Displays vulnerability severity breakdown as a stacked progress bar
 * Shows Critical (red), High (orange), Medium (yellow), Low (blue), Unassigned (gray)
 *
 * Supports two prop styles:
 * 1. Individual values: <VulnerabilityProgressBar critical={5} high={3} ... total={10} />
 * 2. Metrics object: <VulnerabilityProgressBar metrics={component.metrics} />
 */
export function VulnerabilityProgressBar(props: VulnerabilityProgressBarProps) {
  // Extract values - prefer metrics object if provided, otherwise use individual props
  const critical = props.metrics?.critical ?? props.critical ?? 0;
  const high = props.metrics?.high ?? props.high ?? 0;
  const medium = props.metrics?.medium ?? props.medium ?? 0;
  const low = props.metrics?.low ?? props.low ?? 0;
  const unassigned = props.metrics?.unassigned ?? props.unassigned ?? 0;
  const total = props.metrics?.vulnerabilities ?? props.total ?? 0;

  const segments: ProgressSegment[] = [
    { value: critical, color: SEVERITY_COLORS.CRITICAL, label: "Critical" },
    { value: high, color: SEVERITY_COLORS.HIGH, label: "High" },
    { value: medium, color: SEVERITY_COLORS.MEDIUM, label: "Medium" },
    { value: low, color: SEVERITY_COLORS.LOW, label: "Low" },
    { value: unassigned, color: SEVERITY_COLORS.UNASSIGNED, label: "Unassigned" },
  ];

  const tooltip = (
    <div className="text-left">
      <h5 className="mb-2 font-semibold">Severity</h5>
      <div className="space-y-1 text-sm">
        <p>Critical: {critical}</p>
        <p>High: {high}</p>
        <p>Medium: {medium}</p>
        <p>Low: {low}</p>
        <p>Unassigned: {unassigned}</p>
      </div>
      <div className="border-border mt-2 border-t pt-2 text-sm font-semibold">Total: {total}</div>
    </div>
  );

  return <StackedProgressBar segments={segments} total={total} tooltip={tooltip} />;
}
