import { useMemo, useState } from "react";
import { DataTable } from "@/core/components/Table";
import { TABLE } from "@/k8s/constants/tables";
import { useColumns } from "../../hooks/useColumns";
import { useVulnerabilityReportWatchList } from "@/k8s/api/groups/Trivy";
import { EmptyList } from "@/core/components/EmptyList";
import { consolidateImages } from "../../utils/consolidateImages";
import { ResourcesExpandedRow } from "../ResourcesExpandedRow";
import { ConsolidatedVulnerabilityImage } from "../../types";

interface VulnerabilityReportListProps {
  /**
   * Namespace to filter vulnerability reports
   */
  namespace?: string;
}

/**
 * VulnerabilityReportList component displays a table of consolidated Trivy vulnerability images.
 * Groups reports by unique image (digest + namespace) and shows where each image is used
 * in an expandable row.
 */
export function VulnerabilityReportList({ namespace }: VulnerabilityReportListProps) {
  const columns = useColumns();
  const [expandedRowIds, setExpandedRowIds] = useState<Set<string | number>>(new Set());

  const vulnerabilityReportWatchList = useVulnerabilityReportWatchList({ namespace });

  const consolidatedImages = useMemo(
    () => consolidateImages(vulnerabilityReportWatchList.data.array),
    [vulnerabilityReportWatchList.data.array]
  );

  return (
    <DataTable<ConsolidatedVulnerabilityImage>
      id={TABLE.TRIVY_VULNERABILITY_REPORTS_LIST.id}
      data={consolidatedImages}
      columns={columns}
      isLoading={vulnerabilityReportWatchList.isLoading}
      blockerError={vulnerabilityReportWatchList.error ? (vulnerabilityReportWatchList.error as Error) : undefined}
      emptyListComponent={
        <EmptyList
          customText="No vulnerability reports found"
          description="Trivy vulnerability reports will appear here once container images are scanned"
        />
      }
      expandable={{
        getRowId: (row) => row.imageKey,
        expandedRowIds,
        onExpandedRowsChange: setExpandedRowIds,
        expandedRowRender: (row) => <ResourcesExpandedRow resources={row.resources} />,
      }}
      pagination={{
        show: true,
      }}
      settings={{
        show: true,
      }}
    />
  );
}
