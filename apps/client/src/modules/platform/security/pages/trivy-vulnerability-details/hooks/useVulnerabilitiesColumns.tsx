import { useMemo } from "react";
import { TableColumn } from "@/core/components/Table/types";
import { useTableSettings } from "@/core/components/Table/components/TableSettings/hooks/useTableSettings";
import { getSyncedColumnData } from "@/core/components/Table/components/TableSettings/utils";
import { TABLE } from "@/k8s/constants/tables";
import { Vulnerability } from "@my-project/shared";
import { ExternalLink } from "lucide-react";
import { cn } from "@/core/utils/classname";
import { SeverityBadge } from "@/modules/platform/security/components/shared/SeverityBadge";
import { getCvssScoreColorClass } from "@/modules/platform/security/constants/severity";

/**
 * Hook to define columns for the Vulnerabilities table
 */
export function useVulnerabilitiesColumns(): TableColumn<Vulnerability>[] {
  const { loadSettings } = useTableSettings(TABLE.TRIVY_VULNERABILITIES_LIST.id);
  const tableSettings = loadSettings();

  return useMemo(
    () => [
      {
        id: "vulnerabilityID",
        label: "CVE ID",
        data: {
          columnSortableValuePath: "vulnerabilityID",
          render: ({ data }) => {
            if (data.primaryLink) {
              return (
                <a
                  href={data.primaryLink}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-primary inline-flex items-center gap-1 hover:underline"
                >
                  <span className="font-medium">{data.vulnerabilityID}</span>
                  <ExternalLink className="h-3 w-3" />
                </a>
              );
            }
            return <span className="font-medium">{data.vulnerabilityID}</span>;
          },
        },
        cell: {
          isFixed: true,
          baseWidth: 15,
          ...getSyncedColumnData(tableSettings, "vulnerabilityID"),
        },
      },
      {
        id: "severity",
        label: "Severity",
        data: {
          columnSortableValuePath: "severity",
          customSortFn: (a, b) => {
            const severityOrder = { CRITICAL: 5, HIGH: 4, MEDIUM: 3, LOW: 2, UNKNOWN: 1 };
            const orderA = severityOrder[a.severity as keyof typeof severityOrder] || 0;
            const orderB = severityOrder[b.severity as keyof typeof severityOrder] || 0;
            return orderA - orderB;
          },
          render: ({ data }) => <SeverityBadge severity={data.severity} />,
        },
        cell: {
          baseWidth: 10,
          ...getSyncedColumnData(tableSettings, "severity"),
        },
      },
      {
        id: "resource",
        label: "Resource",
        data: {
          columnSortableValuePath: "resource",
          render: ({ data }) => <span className="text-sm">{data.resource || "-"}</span>,
        },
        cell: {
          baseWidth: 15,
          ...getSyncedColumnData(tableSettings, "resource"),
        },
      },
      {
        id: "installedVersion",
        label: "Installed Version",
        data: {
          columnSortableValuePath: "installedVersion",
          render: ({ data }) => (
            <span className="text-muted-foreground font-mono text-xs">{data.installedVersion || "-"}</span>
          ),
        },
        cell: {
          baseWidth: 15,
          ...getSyncedColumnData(tableSettings, "installedVersion"),
        },
      },
      {
        id: "fixedVersion",
        label: "Fixed Version",
        data: {
          columnSortableValuePath: "fixedVersion",
          render: ({ data }) => {
            if (!data.fixedVersion) {
              return <span className="text-muted-foreground text-sm">-</span>;
            }
            return <span className="font-mono text-xs text-green-600 dark:text-green-400">{data.fixedVersion}</span>;
          },
        },
        cell: {
          baseWidth: 15,
          ...getSyncedColumnData(tableSettings, "fixedVersion"),
        },
      },
      {
        id: "score",
        label: "Score",
        data: {
          columnSortableValuePath: "score",
          render: ({ data }) => {
            if (data.score === undefined || data.score === null) {
              return <span className="text-muted-foreground text-sm">-</span>;
            }
            return (
              <span className={cn("font-medium", getCvssScoreColorClass(data.score))}>{data.score.toFixed(1)}</span>
            );
          },
        },
        cell: {
          baseWidth: 7,
          ...getSyncedColumnData(tableSettings, "score"),
        },
      },
      {
        id: "title",
        label: "Title",
        data: {
          columnSortableValuePath: "title",
          render: ({ data }) => (
            <span className="line-clamp-2 text-sm" title={data.title || ""}>
              {data.title || "-"}
            </span>
          ),
        },
        cell: {
          baseWidth: 23,
          ...getSyncedColumnData(tableSettings, "title"),
        },
      },
    ],
    [tableSettings]
  );
}
