import { Badge } from "@/core/components/ui/badge";
import { CopyButton } from "@/core/components/CopyButton";
import { Container } from "lucide-react";
import { VulnerabilityReport, vulnerabilityReportLabels } from "@my-project/shared";
import { TrivyReportDetailHeader } from "@/modules/platform/security/components/shared/TrivyReportDetailHeader";
import { getVulnSummaryStats } from "@/modules/platform/security/components/shared/TrivyReportDetailHeader/utils";

interface ReportHeaderProps {
  report: VulnerabilityReport | undefined;
  isLoading: boolean;
}

export function ReportHeader({ report, isLoading }: ReportHeaderProps) {
  const summary = report?.report.summary;
  const registry = report?.report.registry?.server || "";
  const repository = report?.report.artifact.repository || "";
  const tag = report?.report.artifact.tag || "latest";
  const fullImage = registry ? `${registry}/${repository}:${tag}` : `${repository}:${tag}`;
  const containerName = report?.metadata.labels?.[vulnerabilityReportLabels.containerName] || "";
  const resourceKind = report?.metadata.labels?.[vulnerabilityReportLabels.resourceKind] || "";
  const resourceName = report?.metadata.labels?.[vulnerabilityReportLabels.resourceName] || "";

  const totalVulnerabilities = summary
    ? summary.criticalCount + summary.highCount + summary.mediumCount + summary.lowCount + summary.unknownCount
    : 0;

  return (
    <TrivyReportDetailHeader
      isLoading={isLoading}
      isEmpty={!report}
      icon={Container}
      title={fullImage}
      titleExtra={
        <>
          <CopyButton text={fullImage} />
          {totalVulnerabilities === 0 && summary && (
            <Badge variant="default" className="bg-green-500">
              No Vulnerabilities
            </Badge>
          )}
        </>
      }
      metadata={
        <>
          {containerName && (
            <span>
              Container: <span className="text-foreground">{containerName}</span>
            </span>
          )}
          {resourceKind && resourceName && (
            <span>
              Resource:{" "}
              <span className="text-foreground">
                {resourceKind}/{resourceName}
              </span>
            </span>
          )}
          {report?.metadata.namespace && (
            <span>
              Namespace: <span className="text-foreground">{report.metadata.namespace}</span>
            </span>
          )}
        </>
      }
      badges={
        report?.report.os ? (
          <Badge variant="secondary" className="text-xs">
            {report.report.os.family} {report.report.os.name}
          </Badge>
        ) : undefined
      }
      summaryStats={summary ? getVulnSummaryStats(summary) : []}
    />
  );
}
