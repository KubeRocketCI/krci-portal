import z from "zod";
import { kubeObjectBaseSchema, kubeObjectMetadataSchema } from "../../../common/index.js";

export const vulnerabilitySeverityEnum = z.enum(["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"]);

const vulnerabilitySchema = z.object({
  vulnerabilityID: z.string(),
  resource: z.string().optional(),
  installedVersion: z.string().optional(),
  fixedVersion: z.string().optional(),
  severity: vulnerabilitySeverityEnum,
  score: z.number().optional(),
  title: z.string().optional(),
  primaryLink: z.string().optional(),
  publishedDate: z.string().optional(),
  lastModifiedDate: z.string().optional(),
  links: z.array(z.string()).optional(),
  packagePURL: z.string().optional(),
  target: z.string().optional(),
});

const artifactSchema = z.object({
  digest: z.string().optional(),
  repository: z.string(),
  tag: z.string().optional(),
});

const osSchema = z.object({
  family: z.string().optional(),
  name: z.string().optional(),
});

const registrySchema = z.object({
  server: z.string().optional(),
});

const scannerSchema = z.object({
  name: z.string().optional(),
  vendor: z.string().optional(),
  version: z.string().optional(),
});

const summarySchema = z.object({
  criticalCount: z.number().default(0),
  highCount: z.number().default(0),
  lowCount: z.number().default(0),
  mediumCount: z.number().default(0),
  noneCount: z.number().default(0),
  unknownCount: z.number().default(0),
});

export const vulnerabilityReportSpecSchema = z.object({
  artifact: artifactSchema,
  os: osSchema.optional(),
  registry: registrySchema.optional(),
  scanner: scannerSchema.optional(),
  summary: summarySchema,
  updateTimestamp: z.string().optional(),
  vulnerabilities: z.array(vulnerabilitySchema).optional(),
});

export const vulnerabilityReportSchema = kubeObjectBaseSchema.extend({
  metadata: kubeObjectMetadataSchema,
  report: vulnerabilityReportSpecSchema,
});
